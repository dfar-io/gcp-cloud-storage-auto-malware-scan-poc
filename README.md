# gcp-cloud-storage-auto-malware-scan-poc
POC for Automatic malware scanning for files uploaded to GCP Cloud Storage. This
repo looks to create the [Google-provided solution](https://cloud.google.com/architecture/automate-malware-scanning-for-documents-uploaded-to-cloud-storage)
using Terraform.

## Creating Infrastructure

First, create a Codespace, which comes with Terraform and gcloud installed.


Apply Terraform changes:
```
gcloud auth application-default login
terraform init
terraform apply
```

Download Dockerfile and contents from Google:
```
git clone https://github.com/GoogleCloudPlatform/docker-clamav-malware-scanner.git
cd docker-clamav-malware-scanner/cloudrun-malware-scanner
```

Configure:
```
PROJECT_ID=YOUR_PROJECT_ID
sed "s/-bucket-name/-${PROJECT_ID}/" config.json.tmpl > config.json
```

Perform initial malware DB mirror:
```
python3 -m venv pyenv
. pyenv/bin/activate
pip3 install crcmod cvdupdate
./updateCvdMirror.sh "cvd-mirror-${PROJECT_ID}"
deactivate
```

Deploy Dockerfile to Cloud Run
```
gcloud run deploy "${SERVICE_NAME}" \
  --source . \
  --region "${REGION}" \
  --no-allow-unauthenticated \
  --memory 4Gi \
  --cpu 1 \
  --concurrency 20 \
  --min-instances 1 \
  --max-instances 5 \
  --no-cpu-throttling \
  --cpu-boost \
  --service-account="${SERVICE_ACCOUNT}"
```

## Scenario

1. Log into GCP Console
2. Upload a file to `malware-scanner-intake`
3. Check the logs for the `malware-scanner` Cloud Run container, you should see the file upload event.

## Reference

https://cloud.google.com/architecture/automate-malware-scanning-for-documents-uploaded-to-cloud-storage/deployment
https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/eventarc_trigger
https://cloud.google.com/eventarc/docs/creating-triggers-terraform